!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).MiniSpeedChart=e()}(this,function(){"use strict";var e=function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}};var n=function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)};var o=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var t=function(t){return e(t)||n(t)||o()};var r=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t};var i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(t){r(e,t,n[t])})}return e};var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function s(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var c=function(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var u,l=(function(t,e){t.exports=function(){function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var e=null;function n(t,s,c){return fetch(t).then(function(t){e=t.body.getReader(),function i(){var a=Date.now();e.read().then(function(t){var e=t.done,n=t.value;if(e)c();else{var o=Date.now()-a,r=new Uint8Array(n).byteLength;s(r,o),i()}}).catch(function(t){throw t})}()}),{destroy:function(){e&&e.cancel()}}}var c=null;function r(t,o,e){(c=new XMLHttpRequest).open("GET",t,!0),c.responseType="moz-chunked-arraybuffer";var r=null,n=function(){var t=Date.now(),e=t-r,n=new Uint8Array(c.response).byteLength;o(n,e),r=t},i=function(){2===c.readyState&&(r=Date.now())},a=function(){e()},s=function t(){throw t};return c.addEventListener("progress",n),c.addEventListener("readystatechange",i),c.addEventListener("loadend",a),c.addEventListener("error",s),c.send(),{destroy:function(){c&&(c.abort(),c.removeEventListener("progress",n),c.removeEventListener("readystatechange",i),c.removeEventListener("loadend",a),c.removeEventListener("error",s))}}}return function(){function e(t){(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")})(this,e),this.option=function(r){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},e=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),e.forEach(function(t){var e,n,o;e=r,o=i[n=t],n in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o})}return r}({url:"",loop:!0,detectCallback:function(t){return t}},t),this.loopTimer=null,this.stream=null,this.seconds=[],this.calculateSecond=0,this.streamFactory=function(){if("undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers)return n;if(function(t){try{var e=new XMLHttpRequest;return e.responseType=t,e.responseType===t}catch(t){return!1}}("moz-chunked-arraybuffer"))return r;throw new Error("Your browser does not currently support stream factory")}(),this.detectStartTime=Date.now(),this.detect()}return function(t,e,n){e&&o(t.prototype,e),n&&o(t,n)}(e,[{key:"detect",value:function(){this.requestUrl=this.option.url+"?time="+Date.now(),this.stream=this.streamFactory(this.requestUrl,this.updateCallback.bind(this),this.doneCallback.bind(this))}},{key:"updateCallback",value:function(t,e){var n={streamSize:t,streamTime:e},o=Math.ceil((Date.now()-this.detectStartTime)/1e3);this.seconds[o]?this.seconds[o].push(n):(this.calculate(),this.seconds[o]=[n])}},{key:"doneCallback",value:function(){this.option.loop&&(this.stream&&"function"==typeof this.stream.destroy&&this.stream.destroy(),this.detect())}},{key:"calculate",value:function(){var t=this.seconds[this.calculateSecond++]||[],e=this.resultSum(t,"streamTime")||0,n=this.resultSum(t,"streamSize")||0,o=n/e||0,r=o/1024;this.option.detectCallback({downloadTime:e,downloadSize:n,speedKbps:o,speedMbps:r})}},{key:"resultSum",value:function(t,n){return t.reduce(function(t,e){return t+e[n]},0)}},{key:"destroy",value:function(){this.option.loop=!1,this.loopTimer&&clearTimeout(this.loopTimer),this.stream&&"function"==typeof this.stream.destroy&&this.stream.destroy()}}]),e}()}()}(u={exports:{}},u.exports),u.exports);return function(){function e(t){a(this,e),this.option=i({canvas:"",url:"",width:180,height:20,backgroundColor:"#000",lineColor:"#4f0",lineWidth:2,detectCallback:function(t){return t}},t),this.speeds=[],this.$canvas=document.querySelector(this.option.canvas),this.ctx=this.$canvas.getContext("2d"),this.style(),this.detect()}return c(e,[{key:"style",value:function(){this.$canvas.width=this.option.width,this.$canvas.height=this.option.height,this.$canvas.style.width="".concat(this.option.width,"px"),this.$canvas.style.height="".concat(this.option.height,"px"),this.$canvas.style.backgroundColor=this.option.backgroundColor}},{key:"detect",value:function(){var e=this;this.detect=new l({url:this.option.url,detectCallback:function(t){e.speeds.length*e.option.lineWidth>=e.option.width&&e.speeds.shift(),e.speeds.push(Number(t.speedKbps.toFixed(2))),e.draw(),e.option.detectCallback(t)}})}},{key:"draw",value:function(){var r=this;this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height),this.ctx.fillStyle=this.option.lineColor;var i=Math.min.apply(Math,t(this.speeds)),a=(Math.max.apply(Math,t(this.speeds))-i)/this.option.height;this.speeds.forEach(function(t,e){var n=r.option.height-(t-i)/a,o=r.option.height-n;r.ctx.fillRect(e*r.option.lineWidth,n,r.option.lineWidth,o)})}},{key:"destroy",value:function(){this.speeds=[],this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height),this.detect&&this.detect.destroy()}}]),e}()});
