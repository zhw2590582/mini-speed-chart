!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).MiniSpeedChart=t()}(this,function(){"use strict";var t=function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}};var n=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)};var r=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var e=function(e){return t(e)||n(e)||r()};var i=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};var o=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){i(t,e,n[e])})}return t};var s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var u,h=(function(e,t){e.exports=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(){function t(e){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,t),this.option=function(i){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{},t=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(t=t.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),t.forEach(function(e){var t,n,r;t=i,r=o[n=e],n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r})}return i}({url:"",loop:!0,time:1e3,detectCallback:function(e){return e}},e),this.transportFactory=this.getStreamFactory(),this.detect()}return function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(t,[{key:"supportsXhrResponseType",value:function(e){try{var t=new XMLHttpRequest;return t.responseType=e,t.responseType===e}catch(e){return!1}}},{key:"getStreamFactory",value:function(){return"undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers?this.fetchRequest:this.supportsXhrResponseType("moz-chunked-arraybuffer")?this.mozXhrRequest:this.xhrRequest}},{key:"detect",value:function(){this.timer=null,this.result=[],this.detectStartTime=(new Date).getTime(),this.requestUrl=this.option.url+"?time="+this.detectStartTime,this.transportFactory()}},{key:"fetchRequest",value:function(){var t=this;if("function"!=typeof window.fetch)throw new Error("fetch function is not supported in your environment");return this.reader=null,fetch(this.requestUrl).then(function(e){if("function"!=typeof e.body.getReader)throw new Error("response.body.getReader function is not supported in your environment");t.reader=e.body.getReader(),function i(){var o=this,s=(new Date).getTime();this.reader.read().then(function(e){var t=e.done,n=e.value;if(t)return o.summary(),void(o.option.loop&&(o.timer=setTimeout(o.detect.bind(o),o.option.time)));var r=(new Date).getTime();o.calculate(new Uint8Array(n),r-s),i.call(o)}).catch(function(e){throw e})}.call(t)})}},{key:"mozXhrRequest",value:function(){var n=this;this.xhr=new XMLHttpRequest,this.xhr.open("GET",this.requestUrl,!0),this.xhr.responseType="moz-chunked-arraybuffer";var r=null,e=function(){var e=(new Date).getTime(),t=e-r;n.calculate(new Uint8Array(n.xhr.response),t),r=e},t=function(){2===n.xhr.readyState&&(r=(new Date).getTime())},i=function(){n.summary(),n.option.loop&&(n.timer=setTimeout(n.detect.bind(n),n.option.time))},o=function e(){throw e};this.xhr.addEventListener("progress",e),this.xhr.addEventListener("readystatechange",t),this.xhr.addEventListener("loadend",i),this.xhr.addEventListener("error",o),this.xhr.destroy=function(){n.xhr.removeEventListener("progress",e),n.xhr.removeEventListener("readystatechange",t),n.xhr.removeEventListener("loadend",i),n.xhr.removeEventListener("error",o)},this.xhr.send()}},{key:"calculate",value:function(e,t){this.result.push({streamSize:e.byteLength,streamTime:t})}},{key:"summary",value:function(){var e=(new Date).getTime()-this.detectStartTime,t=this.resultSum("streamTime"),n=e-t,r=this.resultSum("streamSize"),i=r/t,o=i/1024;this.option.detectCallback({detectTime:e,downloadTime:t,downloadSize:r,waitingTime:n,speedKbps:i,speedMbps:o})}},{key:"resultSum",value:function(n){return this.result.reduce(function(e,t){return e+t[n]},0)}},{key:"destroy",value:function(){this.option.loop=!1,this.timer&&clearTimeout(this.timer),this.reader&&"function"==typeof this.reader.cancel&&this.reader.cancel(),this.xhr&&"function"==typeof this.xhr.abort&&(this.xhr.abort(),this.xhr.destroy())}}]),t}()}()}(u={exports:{}},u.exports),u.exports);return function(){function t(e){s(this,t),this.option=o({canvas:"",url:"",width:180,height:20,backgroundColor:"#000",lineColor:"#4f0",lineWidth:2,detectCallback:function(e){return e}},e),this.speeds=[],this.$canvas=document.querySelector(this.option.canvas),this.ctx=this.$canvas.getContext("2d"),this.style(),this.detect()}return c(t,[{key:"style",value:function(){this.$canvas.width=this.option.width,this.$canvas.height=this.option.height,this.$canvas.style.width="".concat(this.option.width,"px"),this.$canvas.style.height="".concat(this.option.height,"px"),this.$canvas.style.backgroundColor=this.option.backgroundColor}},{key:"detect",value:function(){var t=this;this.detect=new h({url:this.option.url,detectCallback:function(e){t.speeds.length*t.option.lineWidth>=t.option.width&&t.speeds.shift(),t.speeds.push(Number(e.speedKbps.toFixed(2))),t.draw(),t.option.detectCallback(e)}})}},{key:"draw",value:function(){var i=this;this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height),this.ctx.fillStyle=this.option.lineColor;var o=Math.min.apply(Math,e(this.speeds)),s=(Math.max.apply(Math,e(this.speeds))-o)/this.option.height;this.speeds.forEach(function(e,t){var n=i.option.height-(e-o)/s,r=i.option.height-n;i.ctx.fillRect(t*i.option.lineWidth,n,i.option.lineWidth,r)})}},{key:"destroy",value:function(){this.speeds=[],this.detect&&this.detect.destroy()}}]),t}()});
