!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).MiniSpeedChart=e()}(this,function(){"use strict";var e=function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}};var n=function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)};var r=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var t=function(t){return e(t)||n(t)||r()};var i=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t};var o=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),r.forEach(function(t){i(e,t,n[t])})}return e};var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function s(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var c=function(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var u,h=(function(t,e){t.exports=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(){function e(t){(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")})(this,e),this.option=function(i){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},e=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(o).filter(function(t){return Object.getOwnPropertyDescriptor(o,t).enumerable}))),e.forEach(function(t){var e,n,r;e=i,r=o[n=t],n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r})}return i}({url:"",loop:!0,time:1e3,detectCallback:function(t){return t}},t),this.transportFactory=this.getStreamFactory(),this.detect()}return function(t,e,n){e&&r(t.prototype,e),n&&r(t,n)}(e,[{key:"supportsXhrResponseType",value:function(t){try{var e=new XMLHttpRequest;return e.responseType=t,e.responseType===t}catch(t){return!1}}},{key:"getStreamFactory",value:function(){return"undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers?this.fetchRequest:this.supportsXhrResponseType("moz-chunked-arraybuffer")?this.mozXhrRequest:this.xhrRequest}},{key:"detect",value:function(){this.timer=null,this.result=[],this.detectStartTime=(new Date).getTime(),this.requestUrl=this.option.url+"?time="+this.detectStartTime,this.transportFactory()}},{key:"fetchRequest",value:function(){var e=this;if("function"!=typeof window.fetch)throw new Error("fetch function is not supported in your environment");return this.reader=null,fetch(this.requestUrl).then(function(t){if("function"!=typeof t.body.getReader)throw new Error("response.body.getReader function is not supported in your environment");e.reader=t.body.getReader(),function i(){var o=this,a=(new Date).getTime();this.reader.read().then(function(t){var e=t.done,n=t.value;if(e)return o.summary(),void(o.option.loop&&(o.timer=setTimeout(o.detect.bind(o),o.option.time)));var r=(new Date).getTime();o.calculate(new Uint8Array(n),r-a),i.call(o)}).catch(function(t){throw t})}.call(e)})}},{key:"mozXhrRequest",value:function(){var n=this;this.xhr=new XMLHttpRequest,this.xhr.open("GET",this.requestUrl,!0),this.xhr.responseType="moz-chunked-arraybuffer";var r=null,t=function(){var t=(new Date).getTime(),e=t-r;n.calculate(new Uint8Array(n.xhr.response),e),r=t},e=function(){2===n.xhr.readyState&&(r=(new Date).getTime())},i=function(){n.summary(),n.option.loop&&(n.timer=setTimeout(n.detect.bind(n),n.option.time))},o=function t(){throw t};this.xhr.addEventListener("progress",t),this.xhr.addEventListener("readystatechange",e),this.xhr.addEventListener("loadend",i),this.xhr.addEventListener("error",o),this.xhr.destroy=function(){n.xhr.removeEventListener("progress",t),n.xhr.removeEventListener("readystatechange",e),n.xhr.removeEventListener("loadend",i),n.xhr.removeEventListener("error",o)},this.xhr.send()}},{key:"calculate",value:function(t,e){this.result.push({streamSize:t.byteLength,streamTime:e})}},{key:"summary",value:function(){var t=(new Date).getTime()-this.detectStartTime,e=this.resultSum("streamTime"),n=t-e,r=this.resultSum("streamSize"),i=r/e,o=i/1024;this.option.detectCallback({detectTime:t,downloadTime:e,downloadSize:r,waitingTime:n,speedKbps:i,speedMbps:o})}},{key:"resultSum",value:function(n){return this.result.reduce(function(t,e){return t+e[n]},0)}},{key:"destroy",value:function(){this.option.loop=!1,this.timer&&clearTimeout(this.timer),this.reader&&"function"==typeof this.reader.cancel&&this.reader.cancel(),this.xhr&&"function"==typeof this.xhr.abort&&(this.xhr.abort(),this.xhr.destroy())}}]),e}()}()}(u={exports:{}},u.exports),u.exports);return function(){function e(t){a(this,e),this.option=o({canvas:"",url:"",width:180,height:20,size:2,backgroundColor:"#000",lineColor:"#4f0",detectCallback:function(t){return t}},t),this.dotMatrix=[],this.$canvas=document.querySelector(this.option.canvas),this.ctx=this.$canvas.getContext("2d"),this.style(),this.detect()}return c(e,[{key:"style",value:function(){this.$canvas.width=this.option.width,this.$canvas.height=this.option.height,this.$canvas.style.width="".concat(this.option.width,"px"),this.$canvas.style.height="".concat(this.option.height,"px"),this.$canvas.style.backgroundColor=this.option.backgroundColor}},{key:"detect",value:function(){var e=this;this.detect=new h({url:this.option.url,detectCallback:function(t){e.dotMatrix.length*e.option.size>=e.option.width&&e.dotMatrix.shift(),e.dotMatrix.push(Number(t.speedKbps.toFixed(2))),e.draw(),e.option.detectCallback(t)}})}},{key:"draw",value:function(){var i=this;this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height),this.ctx.fillStyle=this.option.lineColor;var o=Math.min.apply(Math,t(this.dotMatrix)),a=(Math.max.apply(Math,t(this.dotMatrix))-o)/this.option.height;this.dotMatrix.forEach(function(t,e){if(1===i.dotMatrix.length)i.ctx.fillRect(0,0,i.option.size,i.option.height);else{var n=i.option.height-(t-o)/a,r=i.option.height-n;i.ctx.fillRect(e*i.option.size,n,i.option.size,r)}})}},{key:"destroy",value:function(){this.detect&&this.detect.destroy()}}]),e}()});
